<!DOCTYPE html>  <html> <head>   <title>configuration.coffee</title>   <meta http-equiv="content-type" content="text/html; charset=UTF-8">   <link rel="stylesheet" media="all" href="docco.css" /> </head> <body>   <div id="container">     <div id="background"></div>            <div id="jump_to">         Jump To &hellip;         <div id="jump_wrapper">           <div id="jump_page">                                           <a class="source" href="command.html">                 command.coffee               </a>                                           <a class="source" href="configuration.html">                 configuration.coffee               </a>                                           <a class="source" href="daemon.html">                 daemon.coffee               </a>                                           <a class="source" href="dns_server.html">                 dns_server.coffee               </a>                                           <a class="source" href="http_server.html">                 http_server.coffee               </a>                                           <a class="source" href="index.html">                 index.coffee               </a>                                           <a class="source" href="installer.html">                 installer.coffee               </a>                                           <a class="source" href="logger.html">                 logger.coffee               </a>                                           <a class="source" href="rack_application.html">                 rack_application.coffee               </a>                                           <a class="source" href="util.html">                 util.coffee               </a>                        </div>         </div>       </div>          <table cellpadding="0" cellspacing="0">       <thead>         <tr>           <th class="docs">             <h1>               configuration.coffee             </h1>           </th>           <th class="code">           </th>         </tr>       </thead>       <tbody>                               <tr id="section-1">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-1">&#182;</a>               </div>               <p>The <code>Configuration</code> class encapsulates various options for a Pow
daemon (port numbers, directories, etc.). It's also responsible for
creating <code>Logger</code> instances and mapping hostnames to application
root paths.</p>             </td>             <td class="code">               <div class="highlight"><pre><span class="nv">fs                = </span><span class="nx">require</span> <span class="s">&quot;fs&quot;</span>
<span class="nv">path              = </span><span class="nx">require</span> <span class="s">&quot;path&quot;</span>
<span class="nv">async             = </span><span class="nx">require</span> <span class="s">&quot;async&quot;</span>
<span class="nv">Logger            = </span><span class="nx">require</span> <span class="s">&quot;./logger&quot;</span>
<span class="p">{</span><span class="nx">mkdirp</span><span class="p">}</span>          <span class="o">=</span> <span class="nx">require</span> <span class="s">&quot;./util&quot;</span>
<span class="p">{</span><span class="nx">sourceScriptEnv</span><span class="p">}</span> <span class="o">=</span> <span class="nx">require</span> <span class="s">&quot;./util&quot;</span>
<span class="p">{</span><span class="nx">getUserEnv</span><span class="p">}</span>      <span class="o">=</span> <span class="nx">require</span> <span class="s">&quot;./util&quot;</span>

<span class="nv">module.exports = </span><span class="k">class</span> <span class="nx">Configuration</span></pre></div>             </td>           </tr>                               <tr id="section-2">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-2">&#182;</a>               </div>               <p>The user configuration file, <code>~/.powconfig</code>, is evaluated on
boot.  You can configure options such as the top-level domain,
number of workers, the worker idle timeout, and listening ports.</p>

<pre><code>export POW_DOMAINS=dev,test
export POW_WORKERS=3
</code></pre>

<p>See the <code>Configuration</code> constructor for a complete list of
environment options.</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="vi">@userConfigurationPath: </span><span class="nx">path</span><span class="p">.</span><span class="nx">join</span> <span class="nx">process</span><span class="p">.</span><span class="nx">env</span><span class="p">.</span><span class="nx">HOME</span><span class="p">,</span> <span class="s">&quot;.powconfig&quot;</span></pre></div>             </td>           </tr>                               <tr id="section-3">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-3">&#182;</a>               </div>               <p>Evaluates the user configuration script and calls the <code>callback</code>
with the environment variables if the config file exists. Any
script errors are passed along in the first argument. (No error
occurs if the file does not exist.)</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="vi">@loadUserConfigurationEnvironment: </span><span class="nf">(callback) -&gt;</span>
    <span class="nx">getUserEnv</span> <span class="p">(</span><span class="nx">err</span><span class="p">,</span> <span class="nx">env</span><span class="p">)</span> <span class="o">=&gt;</span>
      <span class="k">if</span> <span class="nx">err</span>
        <span class="nx">callback</span> <span class="nx">err</span>
      <span class="k">else</span>
        <span class="nx">path</span><span class="p">.</span><span class="nx">exists</span> <span class="nv">p = </span><span class="nx">@userConfigurationPath</span><span class="p">,</span> <span class="nf">(exists) -&gt;</span>
          <span class="k">if</span> <span class="nx">exists</span>
            <span class="nx">sourceScriptEnv</span> <span class="nx">p</span><span class="p">,</span> <span class="nx">env</span><span class="p">,</span> <span class="nx">callback</span>
          <span class="k">else</span>
            <span class="nx">callback</span> <span class="kc">null</span><span class="p">,</span> <span class="nx">env</span></pre></div>             </td>           </tr>                               <tr id="section-4">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-4">&#182;</a>               </div>               <p>Creates a Configuration object after evaluating the user
configuration file. Any environment variables in <code>~/.powconfig</code>
affect the process environment and will be copied to spawned
subprocesses.</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="vi">@getUserConfiguration: </span><span class="nf">(callback) -&gt;</span>
    <span class="nx">@loadUserConfigurationEnvironment</span> <span class="nf">(err, env) -&gt;</span>
      <span class="k">if</span> <span class="nx">err</span>
        <span class="nx">callback</span> <span class="nx">err</span>
      <span class="k">else</span>
        <span class="nx">callback</span> <span class="kc">null</span><span class="p">,</span> <span class="k">new</span> <span class="nx">Configuration</span> <span class="nx">env</span></pre></div>             </td>           </tr>                               <tr id="section-5">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-5">&#182;</a>               </div>               <p>A list of option names accessible on <code>Configuration</code> instances.</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="vi">@optionNames: </span><span class="p">[</span>
    <span class="s">&quot;bin&quot;</span><span class="p">,</span> <span class="s">&quot;dstPort&quot;</span><span class="p">,</span> <span class="s">&quot;httpPort&quot;</span><span class="p">,</span> <span class="s">&quot;dnsPort&quot;</span><span class="p">,</span> <span class="s">&quot;timeout&quot;</span><span class="p">,</span> <span class="s">&quot;workers&quot;</span><span class="p">,</span>
    <span class="s">&quot;domains&quot;</span><span class="p">,</span> <span class="s">&quot;extDomains&quot;</span><span class="p">,</span> <span class="s">&quot;hostRoot&quot;</span><span class="p">,</span> <span class="s">&quot;logRoot&quot;</span><span class="p">,</span> <span class="s">&quot;rvmPath&quot;</span>
  <span class="p">]</span></pre></div>             </td>           </tr>                               <tr id="section-6">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-6">&#182;</a>               </div>               <p>Pass in any environment variables you'd like to override when
creating a <code>Configuration</code> instance.</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nv">constructor: </span><span class="nf">(env = process.env) -&gt;</span>
    <span class="vi">@loggers = </span><span class="p">{}</span>
    <span class="nx">@initialize</span> <span class="nx">env</span></pre></div>             </td>           </tr>                               <tr id="section-7">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-7">&#182;</a>               </div>               <p>Valid environment variables and their defaults:</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nv">initialize: </span><span class="nf">(@env) -&gt;</span></pre></div>             </td>           </tr>                               <tr id="section-8">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-8">&#182;</a>               </div>               <p><code>POW_BIN</code>: the path to the <code>pow</code> binary. (This should be
correctly configured for you.)</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="vi">@bin        = </span><span class="nx">env</span><span class="p">.</span><span class="nx">POW_BIN</span>         <span class="o">?</span> <span class="nx">path</span><span class="p">.</span><span class="nx">join</span> <span class="nx">__dirname</span><span class="p">,</span> <span class="s">&quot;../bin/pow&quot;</span></pre></div>             </td>           </tr>                               <tr id="section-9">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-9">&#182;</a>               </div>               <p><code>POW_DST_PORT</code>: the public port Pow expects to be forwarded or
otherwise proxied for incoming HTTP requests. Defaults to <code>80</code>.</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="vi">@dstPort    = </span><span class="nx">env</span><span class="p">.</span><span class="nx">POW_DST_PORT</span>    <span class="o">?</span> <span class="mi">80</span></pre></div>             </td>           </tr>                               <tr id="section-10">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-10">&#182;</a>               </div>               <p><code>POW_HTTP_PORT</code>: the TCP port Pow opens for accepting incoming
HTTP requests. Defaults to <code>20559</code>.</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="vi">@httpPort   = </span><span class="nx">env</span><span class="p">.</span><span class="nx">POW_HTTP_PORT</span>   <span class="o">?</span> <span class="mi">20559</span></pre></div>             </td>           </tr>                               <tr id="section-11">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-11">&#182;</a>               </div>               <p><code>POW_DNS_PORT</code>: the UDP port Pow listens on for incoming DNS
queries. Defaults to <code>20560</code>.</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="vi">@dnsPort    = </span><span class="nx">env</span><span class="p">.</span><span class="nx">POW_DNS_PORT</span>    <span class="o">?</span> <span class="mi">20560</span></pre></div>             </td>           </tr>                               <tr id="section-12">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-12">&#182;</a>               </div>               <p><code>POW_TIMEOUT</code>: how long (in seconds) to leave inactive Rack
applications running before they're killed. Defaults to 15
minutes (900 seconds).</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="vi">@timeout    = </span><span class="nx">env</span><span class="p">.</span><span class="nx">POW_TIMEOUT</span>     <span class="o">?</span> <span class="mi">15</span> <span class="o">*</span> <span class="mi">60</span></pre></div>             </td>           </tr>                               <tr id="section-13">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-13">&#182;</a>               </div>               <p><code>POW_WORKERS</code>: the maximum number of worker processes to spawn
for any given application. Defaults to <code>2</code>.</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="vi">@workers    = </span><span class="nx">env</span><span class="p">.</span><span class="nx">POW_WORKERS</span>     <span class="o">?</span> <span class="mi">2</span></pre></div>             </td>           </tr>                               <tr id="section-14">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-14">&#182;</a>               </div>               <p><code>POW_DOMAINS</code>: the top-level domains for which Pow will respond
to DNS <code>A</code> queries with <code>127.0.0.1</code>. Defaults to <code>dev</code>. If you
configure this in your <code>~/.powconfig</code> you will need to re-run
<code>sudo pow --install-system</code> to make <code>/etc/resolver</code> aware of
the new TLDs.</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="vi">@domains    = </span><span class="nx">env</span><span class="p">.</span><span class="nx">POW_DOMAINS</span>     <span class="o">?</span> <span class="nx">env</span><span class="p">.</span><span class="nx">POW_DOMAIN</span> <span class="o">?</span> <span class="s">&quot;dev&quot;</span></pre></div>             </td>           </tr>                               <tr id="section-15">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-15">&#182;</a>               </div>               <p><code>POW_EXT_DOMAINS</code>: additional top-level domains for which Pow
will serve HTTP requests (but not DNS requests -- hence the
"ext").</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="vi">@extDomains = </span><span class="nx">env</span><span class="p">.</span><span class="nx">POW_EXT_DOMAINS</span> <span class="o">?</span> <span class="p">[]</span></pre></div>             </td>           </tr>                               <tr id="section-16">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-16">&#182;</a>               </div>               <p>Allow for comma-separated domain lists, e.g. <code>POW_DOMAINS=dev,test</code></p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="vi">@domains    = </span><span class="nx">@domains</span><span class="p">.</span><span class="nx">split</span><span class="o">?</span><span class="p">(</span><span class="s">&quot;,&quot;</span><span class="p">)</span>    <span class="o">?</span> <span class="nx">@domains</span>
    <span class="vi">@extDomains = </span><span class="nx">@extDomains</span><span class="p">.</span><span class="nx">split</span><span class="o">?</span><span class="p">(</span><span class="s">&quot;,&quot;</span><span class="p">)</span> <span class="o">?</span> <span class="nx">@extDomains</span>
    <span class="vi">@allDomains = </span><span class="nx">@domains</span><span class="p">.</span><span class="nx">concat</span> <span class="nx">@extDomains</span></pre></div>             </td>           </tr>                               <tr id="section-17">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-17">&#182;</a>               </div>               <p>Support *.xip.io top-level domains.</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="nx">@allDomains</span><span class="p">.</span><span class="nx">push</span> <span class="sr">/\d+\.\d+\.\d+\.\d+\.xip\.io$/</span><span class="p">,</span> <span class="sr">/[0-9a-z]{1,7}\.xip\.io$/</span></pre></div>             </td>           </tr>                               <tr id="section-18">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-18">&#182;</a>               </div>               <p>Runtime support files live in <code>~/Library/Application Support/Pow</code>.</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="vi">@supportRoot = </span><span class="nx">libraryPath</span> <span class="s">&quot;Application Support&quot;</span><span class="p">,</span> <span class="s">&quot;Pow&quot;</span></pre></div>             </td>           </tr>                               <tr id="section-19">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-19">&#182;</a>               </div>               <p><code>POW_HOST_ROOT</code>: path to the directory containing symlinks to
applications that will be served by Pow. Defaults to
<code>~/Library/Application Support/Pow/Hosts</code>.</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="vi">@hostRoot   = </span><span class="nx">env</span><span class="p">.</span><span class="nx">POW_HOST_ROOT</span>   <span class="o">?</span> <span class="nx">path</span><span class="p">.</span><span class="nx">join</span> <span class="nx">@supportRoot</span><span class="p">,</span> <span class="s">&quot;Hosts&quot;</span></pre></div>             </td>           </tr>                               <tr id="section-20">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-20">&#182;</a>               </div>               <p><code>POW_LOG_ROOT</code>: path to the directory that Pow will use to store
its log files. Defaults to <code>~/Library/Logs/Pow</code>.</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="vi">@logRoot    = </span><span class="nx">env</span><span class="p">.</span><span class="nx">POW_LOG_ROOT</span>    <span class="o">?</span> <span class="nx">libraryPath</span> <span class="s">&quot;Logs&quot;</span><span class="p">,</span> <span class="s">&quot;Pow&quot;</span></pre></div>             </td>           </tr>                               <tr id="section-21">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-21">&#182;</a>               </div>               <p><code>POW_RVM_PATH</code> (<strong>deprecated</strong>): path to the rvm initialization
script. Defaults to <code>~/.rvm/scripts/rvm</code>.</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="vi">@rvmPath    = </span><span class="nx">env</span><span class="p">.</span><span class="nx">POW_RVM_PATH</span>    <span class="o">?</span> <span class="nx">path</span><span class="p">.</span><span class="nx">join</span> <span class="nx">process</span><span class="p">.</span><span class="nx">env</span><span class="p">.</span><span class="nx">HOME</span><span class="p">,</span> <span class="s">&quot;.rvm/scripts/rvm&quot;</span></pre></div>             </td>           </tr>                               <tr id="section-22">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-22">&#182;</a>               </div>               <hr />

<p>Precompile regular expressions for matching domain names to be
served by the DNS server and hosts to be served by the HTTP
server.</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="vi">@dnsDomainPattern  = </span><span class="nx">compilePattern</span> <span class="nx">@domains</span>
    <span class="vi">@httpDomainPattern = </span><span class="nx">compilePattern</span> <span class="nx">@allDomains</span></pre></div>             </td>           </tr>                               <tr id="section-23">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-23">&#182;</a>               </div>               <p>Gets an object of the <code>Configuration</code> instance's options that can
be passed to <code>JSON.stringify</code>.</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nv">toJSON: </span><span class="o">-&gt;</span>
    <span class="nv">result = </span><span class="p">{}</span>
    <span class="nx">result</span><span class="p">[</span><span class="nx">key</span><span class="p">]</span> <span class="o">=</span> <span class="nx">@</span><span class="p">[</span><span class="nx">key</span><span class="p">]</span> <span class="k">for</span> <span class="nx">key</span> <span class="k">in</span> <span class="nx">@constructor</span><span class="p">.</span><span class="nx">optionNames</span>
    <span class="nx">result</span></pre></div>             </td>           </tr>                               <tr id="section-24">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-24">&#182;</a>               </div>               <p>Retrieve a <code>Logger</code> instance with the given <code>name</code>.</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nv">getLogger: </span><span class="nf">(name) -&gt;</span>
    <span class="nx">@loggers</span><span class="p">[</span><span class="nx">name</span><span class="p">]</span> <span class="o">||=</span> <span class="k">new</span> <span class="nx">Logger</span> <span class="nx">path</span><span class="p">.</span><span class="nx">join</span> <span class="nx">@logRoot</span><span class="p">,</span> <span class="nx">name</span> <span class="o">+</span> <span class="s">&quot;.log&quot;</span></pre></div>             </td>           </tr>                               <tr id="section-25">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-25">&#182;</a>               </div>               <p>Globally disable or enable RVM deprecation notices by touching or
removing the <code>~/Library/Application
Support/Pow/.disableRvmDeprecationNotices</code> file.</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nv">disableRvmDeprecationNotices: </span><span class="o">-&gt;</span>
    <span class="nx">fs</span><span class="p">.</span><span class="nx">writeFile</span> <span class="nx">path</span><span class="p">.</span><span class="nx">join</span><span class="p">(</span><span class="nx">@supportRoot</span><span class="p">,</span> <span class="s">&quot;.disableRvmDeprecationNotices&quot;</span><span class="p">),</span> <span class="s">&quot;&quot;</span>

  <span class="nv">enableRvmDeprecationNotices: </span><span class="o">-&gt;</span>
    <span class="nx">fs</span><span class="p">.</span><span class="nx">unlink</span> <span class="nx">path</span><span class="p">.</span><span class="nx">join</span> <span class="nx">@supportRoot</span><span class="p">,</span> <span class="s">&quot;.disableRvmDeprecationNotices&quot;</span></pre></div>             </td>           </tr>                               <tr id="section-26">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-26">&#182;</a>               </div>               <p>Search <code>hostRoot</code> for files, symlinks or directories matching the
domain specified by <code>host</code>. If a match is found, the matching domain
name and its configuration are passed as second and third arguments
to <code>callback</code>.  The configuration will either have a <code>root</code> or
a <code>port</code> property.  If no match is found, <code>callback</code> is called
without any arguments.  If an error is raised, <code>callback</code> is called
with the error as its first argument.</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nv">findHostConfiguration: </span><span class="nf">(host = &quot;&quot;, callback) -&gt;</span>
    <span class="nx">@gatherHostConfigurations</span> <span class="p">(</span><span class="nx">err</span><span class="p">,</span> <span class="nx">hosts</span><span class="p">)</span> <span class="o">=&gt;</span>
      <span class="k">return</span> <span class="nx">callback</span> <span class="nx">err</span> <span class="k">if</span> <span class="nx">err</span>
      <span class="k">for</span> <span class="nx">domain</span> <span class="k">in</span> <span class="nx">@allDomains</span>
        <span class="k">for</span> <span class="nx">file</span> <span class="k">in</span> <span class="nx">getFilenamesForHost</span> <span class="nx">host</span><span class="p">,</span> <span class="nx">domain</span>
          <span class="k">if</span> <span class="nv">config = </span><span class="nx">hosts</span><span class="p">[</span><span class="nx">file</span><span class="p">]</span>
            <span class="k">return</span> <span class="nx">callback</span> <span class="kc">null</span><span class="p">,</span> <span class="nx">domain</span><span class="p">,</span> <span class="nx">config</span>

      <span class="k">if</span> <span class="nv">config = </span><span class="nx">hosts</span><span class="p">[</span><span class="s">&quot;default&quot;</span><span class="p">]</span>
        <span class="k">return</span> <span class="nx">callback</span> <span class="kc">null</span><span class="p">,</span> <span class="nx">@allDomains</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="nx">config</span>

      <span class="nx">callback</span> <span class="kc">null</span></pre></div>             </td>           </tr>                               <tr id="section-27">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-27">&#182;</a>               </div>               <p>Asynchronously build a mapping of entries in <code>hostRoot</code> to
application root paths and proxy ports. For each symlink, store the
symlink's name and the real path of the application it points to.
For each directory, store the directory's name and its full path.
For each file that contains a port number, store the file's name and
the port.  The mapping is passed as an object to the second argument
of <code>callback</code>. If an error is raised, <code>callback</code> is called with the
error as its first argument.</p>

<p>The mapping object will look something like this:</p>

<pre><code>{
  "basecamp":  { "root": "/Volumes/37signals/basecamp" },
  "launchpad": { "root": "/Volumes/37signals/launchpad" },
  "37img":     { "root": "/Volumes/37signals/portfolio" },
  "couchdb":   { "url":  "http://localhost:5984" }
}
</code></pre>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nv">gatherHostConfigurations: </span><span class="nf">(callback) -&gt;</span>
    <span class="nv">hosts = </span><span class="p">{}</span>
    <span class="nx">mkdirp</span> <span class="nx">@hostRoot</span><span class="p">,</span> <span class="p">(</span><span class="nx">err</span><span class="p">)</span> <span class="o">=&gt;</span>
      <span class="k">return</span> <span class="nx">callback</span> <span class="nx">err</span> <span class="k">if</span> <span class="nx">err</span>
      <span class="nx">fs</span><span class="p">.</span><span class="nx">readdir</span> <span class="nx">@hostRoot</span><span class="p">,</span> <span class="p">(</span><span class="nx">err</span><span class="p">,</span> <span class="nx">files</span><span class="p">)</span> <span class="o">=&gt;</span>
        <span class="k">return</span> <span class="nx">callback</span> <span class="nx">err</span> <span class="k">if</span> <span class="nx">err</span>
        <span class="nx">async</span><span class="p">.</span><span class="nx">forEach</span> <span class="nx">files</span><span class="p">,</span> <span class="p">(</span><span class="nx">file</span><span class="p">,</span> <span class="nx">next</span><span class="p">)</span> <span class="o">=&gt;</span>
          <span class="nv">root = </span><span class="nx">path</span><span class="p">.</span><span class="nx">join</span> <span class="nx">@hostRoot</span><span class="p">,</span> <span class="nx">file</span>
          <span class="nv">name = </span><span class="nx">file</span><span class="p">.</span><span class="nx">toLowerCase</span><span class="p">()</span>
          <span class="nx">rstat</span> <span class="nx">root</span><span class="p">,</span> <span class="nf">(err, stats, path) -&gt;</span>
            <span class="k">if</span> <span class="nx">stats</span><span class="o">?</span><span class="p">.</span><span class="nx">isDirectory</span><span class="p">()</span>
              <span class="nx">hosts</span><span class="p">[</span><span class="nx">name</span><span class="p">]</span> <span class="o">=</span> <span class="nv">root: </span><span class="nx">path</span>
              <span class="nx">next</span><span class="p">()</span>
            <span class="k">else</span> <span class="k">if</span> <span class="nx">stats</span><span class="o">?</span><span class="p">.</span><span class="nx">isFile</span><span class="p">()</span>
              <span class="nx">fs</span><span class="p">.</span><span class="nx">readFile</span> <span class="nx">path</span><span class="p">,</span> <span class="s">&#39;utf-8&#39;</span><span class="p">,</span> <span class="nf">(err, data) -&gt;</span>
                <span class="k">return</span> <span class="nx">next</span><span class="p">()</span> <span class="k">if</span> <span class="nx">err</span>
                <span class="nv">data = </span><span class="nx">data</span><span class="p">.</span><span class="nx">trim</span><span class="p">()</span>
                <span class="k">if</span> <span class="nx">data</span><span class="p">.</span><span class="nx">length</span> <span class="o">&lt;</span> <span class="mi">10</span> <span class="o">and</span> <span class="o">not</span> <span class="nb">isNaN</span><span class="p">(</span><span class="nb">parseInt</span><span class="p">(</span><span class="nx">data</span><span class="p">))</span>
                  <span class="nx">hosts</span><span class="p">[</span><span class="nx">name</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="nv">url: </span><span class="s">&quot;http://localhost:</span><span class="si">#{</span><span class="nb">parseInt</span><span class="p">(</span><span class="nx">data</span><span class="p">)</span><span class="si">}</span><span class="s">&quot;</span><span class="p">}</span>
                <span class="k">else</span> <span class="k">if</span> <span class="nx">data</span><span class="p">.</span><span class="nx">match</span><span class="p">(</span><span class="s">&quot;https?://&quot;</span><span class="p">)</span>
                  <span class="nx">hosts</span><span class="p">[</span><span class="nx">name</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="nv">url: </span><span class="nx">data</span><span class="p">}</span>
                <span class="nx">next</span><span class="p">()</span>
            <span class="k">else</span>
              <span class="nx">next</span><span class="p">()</span>
        <span class="p">,</span> <span class="nf">(err) -&gt;</span>
          <span class="nx">callback</span> <span class="nx">err</span><span class="p">,</span> <span class="nx">hosts</span></pre></div>             </td>           </tr>                               <tr id="section-28">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-28">&#182;</a>               </div>               <p>Convenience wrapper for constructing paths to subdirectories of
<code>~/Library</code>.</p>             </td>             <td class="code">               <div class="highlight"><pre><span class="nv">libraryPath = </span><span class="nf">(args...) -&gt;</span>
  <span class="nx">path</span><span class="p">.</span><span class="nx">join</span> <span class="nx">process</span><span class="p">.</span><span class="nx">env</span><span class="p">.</span><span class="nx">HOME</span><span class="p">,</span> <span class="s">&quot;Library&quot;</span><span class="p">,</span> <span class="nx">args</span><span class="p">...</span></pre></div>             </td>           </tr>                               <tr id="section-29">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-29">&#182;</a>               </div>               <p>Strip a trailing <code>domain</code> from the given <code>host</code>, then generate a
sorted array of possible entry names for finding which application
should serve the host. For example, a <code>host</code> of
<code>asset0.37s.basecamp.dev</code> will produce <code>["asset0.37s.basecamp",
"37s.basecamp", "basecamp"]</code>, and <code>basecamp.dev</code> will produce
<code>["basecamp"]</code>.</p>             </td>             <td class="code">               <div class="highlight"><pre><span class="nv">getFilenamesForHost = </span><span class="nf">(host, domain) -&gt;</span>
  <span class="nv">host = </span><span class="nx">host</span><span class="p">.</span><span class="nx">toLowerCase</span><span class="p">()</span>
  <span class="nv">domain = </span><span class="nx">host</span><span class="p">.</span><span class="nx">match</span><span class="p">(</span><span class="nx">domain</span><span class="p">)</span><span class="o">?</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">?</span> <span class="s">&quot;&quot;</span> <span class="k">if</span> <span class="nx">domain</span><span class="p">.</span><span class="nx">test</span><span class="o">?</span>

  <span class="k">if</span> <span class="nx">host</span><span class="p">.</span><span class="nx">slice</span><span class="p">(</span><span class="o">-</span><span class="nx">domain</span><span class="p">.</span><span class="nx">length</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">is</span> <span class="s">&quot;.</span><span class="si">#{</span><span class="nx">domain</span><span class="si">}</span><span class="s">&quot;</span>
    <span class="nv">parts  = </span><span class="nx">host</span><span class="p">.</span><span class="nx">slice</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="o">-</span><span class="nx">domain</span><span class="p">.</span><span class="nx">length</span> <span class="o">-</span> <span class="mi">1</span><span class="p">).</span><span class="nx">split</span> <span class="s">&quot;.&quot;</span>
    <span class="nv">length = </span><span class="nx">parts</span><span class="p">.</span><span class="nx">length</span>
    <span class="k">for</span> <span class="nx">i</span> <span class="k">in</span> <span class="p">[</span><span class="mi">0</span><span class="p">...</span><span class="nx">length</span><span class="p">]</span>
      <span class="nx">parts</span><span class="p">.</span><span class="nx">slice</span><span class="p">(</span><span class="nx">i</span><span class="p">,</span> <span class="nx">length</span><span class="p">).</span><span class="nx">join</span> <span class="s">&quot;.&quot;</span>
  <span class="k">else</span>
    <span class="p">[]</span></pre></div>             </td>           </tr>                               <tr id="section-30">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-30">&#182;</a>               </div>               <p>Similar to <code>fs.stat</code>, but passes the realpath of the file as the
third argument to the callback.</p>             </td>             <td class="code">               <div class="highlight"><pre><span class="nv">rstat = </span><span class="nf">(path, callback) -&gt;</span>
  <span class="nx">fs</span><span class="p">.</span><span class="nx">lstat</span> <span class="nx">path</span><span class="p">,</span> <span class="nf">(err, stats) -&gt;</span>
    <span class="k">if</span> <span class="nx">err</span>
      <span class="nx">callback</span> <span class="nx">err</span>
    <span class="k">else</span> <span class="k">if</span> <span class="nx">stats</span><span class="o">?</span><span class="p">.</span><span class="nx">isSymbolicLink</span><span class="p">()</span>
      <span class="nx">fs</span><span class="p">.</span><span class="nx">realpath</span> <span class="nx">path</span><span class="p">,</span> <span class="nf">(err, realpath) -&gt;</span>
        <span class="k">if</span> <span class="nx">err</span> <span class="k">then</span> <span class="nx">callback</span> <span class="nx">err</span>
        <span class="k">else</span> <span class="nx">rstat</span> <span class="nx">realpath</span><span class="p">,</span> <span class="nx">callback</span>
    <span class="k">else</span>
      <span class="nx">callback</span> <span class="nx">err</span><span class="p">,</span> <span class="nx">stats</span><span class="p">,</span> <span class="nx">path</span></pre></div>             </td>           </tr>                               <tr id="section-31">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-31">&#182;</a>               </div>               <p>Helper function for compiling a list of top-level domains into a
regular expression for matching purposes.</p>             </td>             <td class="code">               <div class="highlight"><pre><span class="nv">compilePattern = </span><span class="nf">(domains) -&gt;</span>
  <span class="o">///</span> <span class="p">(</span> <span class="p">(</span><span class="o">^|</span><span class="err">\</span><span class="p">.)</span> <span class="p">(</span><span class="c1">#{domains.join(&quot;|&quot;)}) ) \.? $ ///i</span>

</pre></div>             </td>           </tr>                </tbody>     </table>   </div> </body> </html> 